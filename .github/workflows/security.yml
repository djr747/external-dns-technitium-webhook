name: Security Scanning

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight (run container rebuild/scan daily)
  workflow_dispatch:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write

jobs:
  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'python' ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{matrix.language}}"

  trivy-scan:
    name: Trivy Container Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Build Docker image for scanning
        run: docker build -t external-dns-technitium-webhook:${{ github.sha }} .

      - name: Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: external-dns-technitium-webhook:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          vuln-type: 'os,library'
          scanners: 'vuln,secret,config'

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy vulnerability scanner (JSON)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: external-dns-technitium-webhook:${{ github.sha }}
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Generate Trivy summary
        if: always()
        run: |
          echo "### Trivy Vulnerability Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-results.json)
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' trivy-results.json)
          MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "MEDIUM")] | length' trivy-results.json)
          LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "LOW")] | length' trivy-results.json)
          
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ  High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ Medium | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”µ Low | $LOW |" >> $GITHUB_STEP_SUMMARY

      - name: Upload Trivy results artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-results
          path: trivy-results.json
          retention-days: 90

  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run pip-audit for CVE scanning
        run: |
          pip install pip-audit
          pip-audit --desc --format json --output pip-audit-report.json || true
          pip-audit --desc --format markdown --output pip-audit-report.md || true

      - name: Upload pip-audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-report
          path: |
            pip-audit-report.json
            pip-audit-report.md
          retention-days: 90

      - name: Display pip-audit summary
        if: always()
        run: |
          if [ -f pip-audit-report.md ]; then
            echo "### pip-audit CVE Scan Results" >> $GITHUB_STEP_SUMMARY
            cat pip-audit-report.md >> $GITHUB_STEP_SUMMARY
          fi

  code-scan:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install a pinned Bandit version and Semgrep. Use the same Bandit
          # version we validate locally (compatible with Python 3.13).
          pip install 'bandit[toml]==1.8.6' semgrep

      - name: Run Bandit security linter
        run: |
          bandit -r external_dns_technitium_webhook -f json -o bandit-report.json || true
          bandit -r external_dns_technitium_webhook -f txt -o bandit-report.txt || true

      - name: Upload Bandit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: |
            bandit-report.json
            bandit-report.txt
          retention-days: 90

      - name: Run Semgrep security scan
        run: |
          semgrep --config=auto --json --output=semgrep-report.json external_dns_technitium_webhook/ || true

      - name: Upload Semgrep results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-report
          path: semgrep-report.json
          retention-days: 90

  snyk-security:
    name: Snyk Security Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium --sarif-file-output=snyk-code.sarif

      - name: Upload Snyk results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: snyk-code.sarif

      - name: Run Snyk monitor (track over time)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor
          args: --project-name=${{ github.repository }}

      # Container scanning with Snyk
      - name: Build Docker image for Snyk container scan
        run: docker build -t external-dns-technitium-webhook:${{ github.sha }} .

      - name: Run Snyk Container Scan (SARIF)
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: external-dns-technitium-webhook:${{ github.sha }}
          args: --severity-threshold=medium --sarif-file-output=snyk-container.sarif

      - name: Upload Snyk container SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk-container.sarif

      - name: Set up Node.js for Snyk CLI
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Snyk CLI
        run: npm install -g snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Run Snyk container test (JSON)
        id: snyk-json
        run: |
          # run test and write JSON output; allow non-zero exit so we can inspect results
          snyk container test external-dns-technitium-webhook:${{ github.sha }} --json > snyk-container.json || true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Upload Snyk JSON results
        uses: actions/upload-artifact@v4
        with:
          name: snyk-container-json
          path: snyk-container.json

      - name: Fail on HIGH or CRITICAL Snyk vulnerabilities
        run: |
          if [ ! -f snyk-container.json ]; then echo "snyk-container.json not found"; exit 0; fi
          HIGH_COUNT=$(jq '[.vulnerabilities[]? | select(.severity=="high" or .severity=="critical")] | length' snyk-container.json)
          echo "Found $HIGH_COUNT high/critical Snyk vulnerabilities"
          if [ "$HIGH_COUNT" -gt 0 ]; then
            echo "Failing because high/critical vulnerabilities found by Snyk"
            exit 1
          fi

      - name: Run Snyk container monitor (track over time)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: external-dns-technitium-webhook:${{ github.sha }}
          command: monitor
          args: --project-name=${{ github.repository }}-container

  sbom-generation:
    name: SBOM Generation and Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Build Docker image
        run: docker build -t external-dns-technitium-webhook:${{ github.sha }} .

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          image: external-dns-technitium-webhook:${{ github.sha }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Generate SBOM in CycloneDX format
        uses: anchore/sbom-action@v0
        with:
          image: external-dns-technitium-webhook:${{ github.sha }}
          format: cyclonedx-json
          output-file: sbom.cyclonedx.json

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-reports
          path: |
            sbom.spdx.json
            sbom.cyclonedx.json
          retention-days: 90

      - name: Scan SBOM with Grype
        uses: anchore/scan-action@v7
        id: grype
        with:
          sbom: sbom.spdx.json
          fail-build: false
          severity-cutoff: high

      - name: Upload Grype results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: ${{ steps.grype.outputs.sarif }}

  security-summary:
    name: Security Summary Report
    runs-on: ubuntu-latest
    needs: [trivy-scan, dependency-scan, code-scan, snyk-security, sbom-generation]
    if: always()
    steps:
      - name: Generate security summary
        run: |
          echo "### ðŸ”’ Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All security scans have completed. Check the Security tab for detailed results." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scans performed:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Container vulnerability scan (Trivy)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependency CVE check (pip-audit)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code security analysis (Bandit, Semgrep)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Snyk vulnerability detection" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SBOM generation and analysis" >> $GITHUB_STEP_SUMMARY

